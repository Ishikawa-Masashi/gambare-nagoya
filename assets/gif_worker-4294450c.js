(function(){"use strict";const tt=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535];function et(t,r,e,d){const g=Math.max(2,d),T=new Uint8Array(256),x=new Int32Array(5003),m=new Int32Array(5003);let B,S=0,E,M=0,y,A=!1,D,_,k;function i(h,a){T[E++]=h,E>=254&&o(a)}function s(h){u(5003),M=_+2,A=!0,p(_,h)}function u(h){for(let a=0;a<h;++a)x[a]=-1}function n(h,a){let b,F,P,G,v,j,H;for(D=h,A=!1,n_bits=D,y=f(n_bits),_=1<<h-1,k=_+1,M=_+2,E=0,G=l(),H=0,b=5003;b<65536;b*=2)++H;H=8-H,j=5003,u(j),p(_,a);t:for(;(F=l())!=-1;){if(b=(F<<12)+G,P=F<<H^G,x[P]===b){G=m[P];continue}else if(x[P]>=0){v=j-P,P===0&&(v=1);do if((P-=v)<0&&(P+=j),x[P]===b){G=m[P];continue t}while(x[P]>=0)}p(G,a),G=F,M<1<<12?(m[P]=M++,x[P]=b):s(a)}p(G,a),p(k,a)}function c(h){h.writeByte(g),remaining=t*r,curPixel=0,n(g+1,h),h.writeByte(0)}function o(h){E>0&&(h.writeByte(E),h.writeBytes(T,0,E),E=0)}function f(h){return(1<<h)-1}function l(){return remaining===0?-1:(--remaining,e[curPixel++]&255)}function p(h,a){for(B&=tt[S],S>0?B|=h<<S:B=h,S+=n_bits;S>=8;)i(B&255,a),B>>=8,S-=8;if((M>y||A)&&(A?(y=f(n_bits=D),A=!1):(++n_bits,n_bits==12?y=1<<12:y=f(n_bits))),h==k){for(;S>0;)i(B&255,a),B>>=8,S-=8;o(a)}}this.encode=c}const it=100,I=256,N=I-1,z=4,L=16,Z=1<<L,Q=10,O=10,st=Z>>O,nt=Z<<Q-O,ot=I>>3,q=6,rt=1<<q,lt=ot*rt,ht=30,W=10,R=1<<W,X=8,J=1<<X,U=1<<W+X,K=499,Y=491,$=487,V=503,at=3*V;function ct(t,r){let e,d,g,T,x;function m(){e=[],d=new Int32Array(256),g=new Int32Array(I),T=new Int32Array(I),x=new Int32Array(I>>3);let i,s;for(i=0;i<I;i++)s=(i<<z+8)/I,e[i]=new Float64Array([s,s,s,0]),T[i]=Z/I,g[i]=0}function B(){for(let i=0;i<I;i++)e[i][0]>>=z,e[i][1]>>=z,e[i][2]>>=z,e[i][3]=i}function S(i,s,u,n,c){e[s][0]-=i*(e[s][0]-u)/R,e[s][1]-=i*(e[s][1]-n)/R,e[s][2]-=i*(e[s][2]-c)/R}function E(i,s,u,n,c){const o=Math.abs(s-i),f=Math.min(s+i,I);let l=s+1,p=s-1,h=1,a,b;for(;l<f||p>o;)b=x[h++],l<f&&(a=e[l++],a[0]-=b*(a[0]-u)/U,a[1]-=b*(a[1]-n)/U,a[2]-=b*(a[2]-c)/U),p>o&&(a=e[p--],a[0]-=b*(a[0]-u)/U,a[1]-=b*(a[1]-n)/U,a[2]-=b*(a[2]-c)/U)}function M(i,s,u){let n=2147483647,c=n,o=-1,f=o,l,p,h,a,b;for(l=0;l<I;l++)p=e[l],h=Math.abs(p[0]-i)+Math.abs(p[1]-s)+Math.abs(p[2]-u),h<n&&(n=h,o=l),a=h-(g[l]>>L-z),a<c&&(c=a,f=l),b=T[l]>>O,T[l]-=b,g[l]+=b<<Q;return T[o]+=st,g[o]-=nt,f}function y(){let i,s,u,n,c,o,f=0,l=0;for(i=0;i<I;i++){for(u=e[i],c=i,o=u[1],s=i+1;s<I;s++)n=e[s],n[1]<o&&(c=s,o=n[1]);if(n=e[c],i!=c&&(s=n[0],n[0]=u[0],u[0]=s,s=n[1],n[1]=u[1],u[1]=s,s=n[2],n[2]=u[2],u[2]=s,s=n[3],n[3]=u[3],u[3]=s),o!=f){for(d[f]=l+i>>1,s=f+1;s<o;s++)d[s]=i;f=o,l=i}}for(d[f]=l+N>>1,s=f+1;s<256;s++)d[s]=N}function A(i,s,u){let n,c,o,f=1e3,l=-1,p=d[s],h=p-1;for(;p<I||h>=0;)p<I&&(c=e[p],o=c[1]-s,o>=f?p=I:(p++,o<0&&(o=-o),n=c[0]-i,n<0&&(n=-n),o+=n,o<f&&(n=c[2]-u,n<0&&(n=-n),o+=n,o<f&&(f=o,l=c[3])))),h>=0&&(c=e[h],o=s-c[1],o>=f?h=-1:(h--,o<0&&(o=-o),n=c[0]-i,n<0&&(n=-n),o+=n,o<f&&(n=c[2]-u,n<0&&(n=-n),o+=n,o<f&&(f=o,l=c[3]))));return l}function D(){let i;const s=t.length,u=30+(r-1)/3,n=s/(3*r);let c=~~(n/it),o=R,f=lt,l=f>>q;for(l<=1&&(l=0),i=0;i<l;i++)x[i]=o*((l*l-i*i)*J/(l*l));let p;s<at?(r=1,p=3):s%K!==0?p=3*K:s%Y!==0?p=3*Y:s%$!==0?p=3*$:p=3*V;let h,a,b,F,P=0;for(i=0;i<n;)if(h=(t[P]&255)<<z,a=(t[P+1]&255)<<z,b=(t[P+2]&255)<<z,F=M(h,a,b),S(o,F,h,a,b),l!==0&&E(l,F,h,a,b),P+=p,P>=s&&(P-=s),i++,c===0&&(c=1),i%c===0)for(o-=o/u,f-=f/ht,l=f>>q,l<=1&&(l=0),F=0;F<l;F++)x[F]=o*((l*l-F*F)*J/(l*l))}function _(){m(),D(),B(),y()}this.buildColormap=_;function k(){const i=[],s=[];for(let n=0;n<I;n++)s[e[n][3]]=n;let u=0;for(let n=0;n<I;n++){const c=s[n];i[u++]=e[c][0],i[u++]=e[c][1],i[u++]=e[c][2]}return i}this.getColormap=k,this.lookupRGB=A}function C(){this.page=-1,this.pages=[],this.newPage()}C.pageSize=4096,C.charMap={};for(let t=0;t<256;t++)C.charMap[t]=String.fromCharCode(t);C.prototype.newPage=function(){this.pages[++this.page]=new Uint8Array(C.pageSize),this.cursor=0},C.prototype.getData=function(){let t="";for(let r=0;r<this.pages.length;r++)for(let e=0;e<C.pageSize;e++)t+=C.charMap[this.pages[r][e]];return t},C.prototype.writeByte=function(t){this.cursor>=C.pageSize&&this.newPage(),this.pages[this.page][this.cursor++]=t},C.prototype.writeUTFBytes=function(t){for(let r=t.length,e=0;e<r;e++)this.writeByte(t.charCodeAt(e))},C.prototype.writeBytes=function(t,r,e){for(let d=e||t.length,g=r||0;g<d;g++)this.writeByte(t[g])};function w(t,r){this.width=~~t,this.height=~~r,this.transparent=null,this.transIndex=0,this.repeat=-1,this.delay=0,this.image=null,this.pixels=null,this.indexedPixels=null,this.colorDepth=null,this.colorTab=null,this.usedEntry=[],this.palSize=7,this.dispose=-1,this.firstFrame=!0,this.sample=10,this.dither=!1,this.globalPalette=!1,this.out=new C}w.prototype.setDelay=function(t){this.delay=Math.round(t/10)},w.prototype.setFrameRate=function(t){this.delay=Math.round(100/t)},w.prototype.setDispose=function(t){t>=0&&(this.dispose=t)},w.prototype.setRepeat=function(t){this.repeat=t},w.prototype.setTransparent=function(t){this.transparent=t},w.prototype.addFrame=function(t){this.image=t,this.colorTab=this.globalPalette.slice?this.globalPalette:null,this.getImagePixels(),this.analyzePixels(),this.globalPalette===!0&&(this.globalPalette=this.colorTab),this.firstFrame&&(this.writeLSD(),this.writePalette(),this.repeat>=0&&this.writeNetscapeExt()),this.writeGraphicCtrlExt(),this.writeImageDesc(),!this.firstFrame&&!this.globalPalette&&this.writePalette(),this.writePixels(),this.firstFrame=!1},w.prototype.finish=function(){this.out.writeByte(59)},w.prototype.setQuality=function(t){t<1&&(t=1),this.sample=t},w.prototype.setDither=function(t){t===!0&&(t="FloydSteinberg"),this.dither=t},w.prototype.setGlobalPalette=function(t){this.globalPalette=t},w.prototype.getGlobalPalette=function(){return this.globalPalette.slice&&this.globalPalette.slice(0)||this.globalPalette},w.prototype.writeHeader=function(){this.out.writeUTFBytes("GIF89a")},w.prototype.analyzePixels=function(){if(!this.colorTab){const t=new ct(this.pixels,this.sample);t.buildColormap(),this.colorTab=t.getColormap()}this.dither?this.ditherPixels(this.dither.replace("-serpentine",""),this.dither.match(/-serpentine/)!==null):this.indexPixels(),this.pixels=null,this.colorDepth=8,this.palSize=7,this.transparent!==null&&(this.transIndex=this.findClosest(this.transparent,!0))},w.prototype.indexPixels=function(t){const r=this.pixels.length/3;this.indexedPixels=new Uint8Array(r);let e=0;for(let d=0;d<r;d++){const g=this.findClosestRGB(this.pixels[e++]&255,this.pixels[e++]&255,this.pixels[e++]&255);this.usedEntry[g]=!0,this.indexedPixels[d]=g}},w.prototype.ditherPixels=function(t,r){const e={FalseFloydSteinberg:[[.375,1,0],[.375,0,1],[.25,1,1]],FloydSteinberg:[[.4375,1,0],[.1875,-1,1],[.3125,0,1],[.0625,1,1]],Stucki:[[.19047619047619047,1,0],[.09523809523809523,2,0],[.047619047619047616,-2,1],[.09523809523809523,-1,1],[.19047619047619047,0,1],[.09523809523809523,1,1],[.047619047619047616,2,1],[.023809523809523808,-2,2],[.047619047619047616,-1,2],[.09523809523809523,0,2],[.047619047619047616,1,2],[.023809523809523808,2,2]],Atkinson:[[.125,1,0],[.125,2,0],[.125,-1,1],[.125,0,1],[.125,1,1],[.125,0,2]]};if(!t||!e[t])throw"Unknown dithering kernel: "+t;const d=e[t];let g=0,T=this.height,x=this.width,m=this.pixels,B=r?-1:1;this.indexedPixels=new Uint8Array(this.pixels.length/3);for(let S=0;S<T;S++){r&&(B=B*-1);for(let E=B==1?0:x-1,M=B==1?x:0;E!==M;E+=B){g=S*x+E;let y=g*3;const A=m[y],D=m[y+1],_=m[y+2];y=this.findClosestRGB(A,D,_),this.usedEntry[y]=!0,this.indexedPixels[g]=y,y*=3;const k=this.colorTab[y],i=this.colorTab[y+1],s=this.colorTab[y+2],u=A-k,n=D-i,c=_-s;for(let o=B==1?0:d.length-1,f=B==1?d.length:0;o!==f;o+=B){const l=d[o][1],p=d[o][2];if(l+E>=0&&l+E<x&&p+S>=0&&p+S<T){const h=d[o][0];y=g+l+p*x,y*=3,m[y]=Math.max(0,Math.min(255,m[y]+u*h)),m[y+1]=Math.max(0,Math.min(255,m[y+1]+n*h)),m[y+2]=Math.max(0,Math.min(255,m[y+2]+c*h))}}}}},w.prototype.findClosest=function(t,r){return this.findClosestRGB((t&16711680)>>16,(t&65280)>>8,t&255,r)},w.prototype.findClosestRGB=function(t,r,e,d){if(this.colorTab===null)return-1;let g=0,T=256*256*256;const x=this.colorTab.length;for(let m=0;m<x;){const B=t-(this.colorTab[m++]&255),S=r-(this.colorTab[m++]&255),E=e-(this.colorTab[m]&255),M=B*B+S*S+E*E,y=parseInt(m/3);(!d||this.usedEntry[y])&&M<T&&(T=M,g=y),m++}return g},w.prototype.getImagePixels=function(){const t=this.width,r=this.height;this.pixels=new Uint8Array(t*r*3);const e=this.image;let d=0;for(let g=0;g<r;g++)for(let T=0;T<t;T++){const x=g*t*4+T*4;this.pixels[d++]=e[x],this.pixels[d++]=e[x+1],this.pixels[d++]=e[x+2]}},w.prototype.writeGraphicCtrlExt=function(){this.out.writeByte(33),this.out.writeByte(249),this.out.writeByte(4);let t,r;this.transparent===null?(t=0,r=0):(t=1,r=2),this.dispose>=0&&(r=dispose&7),r<<=2,this.out.writeByte(0|r|0|t),this.writeShort(this.delay),this.out.writeByte(this.transIndex),this.out.writeByte(0)},w.prototype.writeImageDesc=function(){this.out.writeByte(44),this.writeShort(0),this.writeShort(0),this.writeShort(this.width),this.writeShort(this.height),this.firstFrame||this.globalPalette?this.out.writeByte(0):this.out.writeByte(128|this.palSize)},w.prototype.writeLSD=function(){this.writeShort(this.width),this.writeShort(this.height),this.out.writeByte(240|this.palSize),this.out.writeByte(0),this.out.writeByte(0)},w.prototype.writeNetscapeExt=function(){this.out.writeByte(33),this.out.writeByte(255),this.out.writeByte(11),this.out.writeUTFBytes("NETSCAPE2.0"),this.out.writeByte(3),this.out.writeByte(1),this.writeShort(this.repeat),this.out.writeByte(0)},w.prototype.writePalette=function(){this.out.writeBytes(this.colorTab);const t=3*256-this.colorTab.length;for(let r=0;r<t;r++)this.out.writeByte(0)},w.prototype.writeShort=function(t){this.out.writeByte(t&255),this.out.writeByte(t>>8&255)},w.prototype.writePixels=function(){new et(this.width,this.height,this.indexedPixels,this.colorDepth).encode(this.out)},w.prototype.stream=function(){return this.out},self.onmessage=function(t){const r=t.data,e=new w(r.width,r.height);r.id===0?e.writeHeader():e.firstFrame=!1,e.setTransparent(null),e.setRepeat(0),e.setDelay(r.delay*1e3),e.setQuality(r.quality),e.setDither(r.dither),e.addFrame(r.data),r.last&&e.finish(),r.globalPalette&&(r.globalPalette=e.getGlobalPalette());const d=e.stream();postMessage({data:d.pages,cursor:d.cursor,pageSize:d.constructor.pageSize})}})();
